<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OpenLoong Dynamics Control: Develop</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">OpenLoong Dynamics Control
   &#160;<span id="projectnumber">v0.1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Develop </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md16"></a>
Developer's Guide</h1>
<h2><a class="anchor" id="autotoc_md17"></a>
Abbreviations</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">prefix/suffix   </th><th class="markdownTableHeadNone">meaning    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">*_L, _W*   </td><td class="markdownTableBodyNone">Local frame, World frame    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><em>fe_</em>   </td><td class="markdownTableBodyNone">foot end    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">*_L, _l, _R, _r*   </td><td class="markdownTableBodyNone">Left, Right    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><em>swing,</em> <em>sw</em>   </td><td class="markdownTableBodyNone">swing leg    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><em>stance,</em> <em>st</em>   </td><td class="markdownTableBodyNone">stance leg    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><em>eul, rpy</em>   </td><td class="markdownTableBodyNone">angular position expressed by euler angle    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><em>omega</em>   </td><td class="markdownTableBodyNone">angular velocity    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><em>pos</em>   </td><td class="markdownTableBodyNone">linear position    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><em>vel</em>   </td><td class="markdownTableBodyNone">linear velocity    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><em>tor</em>, tau*   </td><td class="markdownTableBodyNone">torque at joint    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><em>base</em>   </td><td class="markdownTableBodyNone">baselink    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">*_des*   </td><td class="markdownTableBodyNone">desired value    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">*_cur*   </td><td class="markdownTableBodyNone">current value    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">*_rot*   </td><td class="markdownTableBodyNone">rotation matrix   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md18"></a>
key control parameters</h2>
<ul>
<li><a class="el" href="classMPC.html">MPC</a> parameters <div class="fragment"><div class="line"> {C++}</div>
<div class="line">//MPC.h</div>
<div class="line">void    set_weight(double u_weight, Eigen::MatrixXd L_diag, Eigen::MatrixXd K_diag);</div>
<div class="line">//*u_weight* : the minimal weight of control input</div>
<div class="line">//*L_diag* : the weight of error compared to desired values, following the order (eul, pos, omega, vel)</div>
<div class="line">//*K_diag* : the weight of control input, following the order (fl, tl, fr, tr)</div>
</div><!-- fragment --></li>
<li>WBC priority <div class="fragment"><div class="line"> {C++}</div>
<div class="line">//WBC_QP.cpp</div>
<div class="line">std::vector&lt;std::string taskOrder;</div>
<div class="line">taskOrder.emplace_back(&quot;RedundantJoints&quot;);</div>
<div class="line">taskOrder.emplace_back(&quot;static_Contact&quot;);</div>
<div class="line">taskOrder.emplace_back(&quot;Roll_Pitch_Yaw_Pz&quot;);</div>
<div class="line">taskOrder.emplace_back(&quot;PxPy&quot;);</div>
<div class="line">taskOrder.emplace_back(&quot;SwingLeg&quot;);</div>
<div class="line">taskOrder.emplace_back(&quot;HandTrack&quot;);</div>
<div class="line">// add task or adjust the priority here</div>
</div><!-- fragment --></li>
<li>WBC weight <div class="fragment"><div class="line"> {C++}</div>
<div class="line">//PriorityTasks.h</div>
<div class="line">Eigen::MatrixXd Kp;                //weight of position error</div>
<div class="line">Eigen::MatrixXd Kd;                //weight of velocity eror</div>
<div class="line">//WBC_QP.h</div>
<div class="line">Eigen::MatrixXd Q1;                //weight of the contact force error compared to desired, following the order (fl, tl, fr, tr)</div>
<div class="line">Eigen::MatrixXd Q2;                //weight of the acceleration tracking error</div>
</div><!-- fragment --></li>
<li>Swing leg trajectory <div class="fragment"><div class="line"> {C++}</div>
<div class="line">//FootPlacement.h</div>
<div class="line">double kp_vx;                                 //x-direction footplacement parameter</div>
<div class="line">double kp_vy;                                 //y-direction footplacement parameter</div>
<div class="line">double kp_wz;                                 //z-direction posture parameter</div>
<div class="line">double stepHeight;                            //the maximal step height</div>
<div class="line"> </div>
<div class="line">//FootPlacement.cpp</div>
<div class="line">double    FootPlacement::Trajectory(double phase, double des1, double des2);        //z-direction posture trajectory</div>
<div class="line">//phase：the phase when reaching the highest</div>
<div class="line">//des1：the highest position along the trajectory</div>
<div class="line">//des2：the final position of the trajectory</div>
</div><!-- fragment --></li>
<li>Gait control <div class="fragment"><div class="line"> {C++}</div>
<div class="line">//GaitScheduler.h</div>
<div class="line">double tSwing;                                         //the time of one step</div>
<div class="line">double FzThrehold;                                     //the maximal force when touching the ground</div>
<div class="line"> </div>
<div class="line">//GaitScheduler.cpp</div>
<div class="line">DataBus::LegState legState=DataBus::RSt;                //the first step state</div>
</div><!-- fragment --></li>
<li>Joint parameter <div class="fragment"><div class="line">//JointCtrConfig.json</div>
<div class="line">   &quot;Joint-ankel-l-pitch&quot; : {</div>
<div class="line">      &quot;PVT_LPF_Fc&quot; : 20,</div>
<div class="line">      &quot;kd&quot; : 5.0,</div>
<div class="line">      &quot;kp&quot; : 50.0,</div>
<div class="line">      &quot;maxPos&quot; : 0.61087,</div>
<div class="line">      &quot;maxSpeed&quot; : 48.8,</div>
<div class="line">      &quot;maxTorque&quot; : 58.5,</div>
<div class="line">      &quot;minPos&quot; : -0.43644</div>
<div class="line">   }</div>
</div><!-- fragment --></li>
</ul>
<h2><a class="anchor" id="autotoc_md19"></a>
Instructions to replace robot model</h2>
<h3><a class="anchor" id="autotoc_md20"></a>
model file</h3>
<p><b>1. xml file preparation</b></p>
<p>prepare the urdf (.urdf) file and mesh file (.stl) of the robot for adding the mujoco compiling tags </p><div class="fragment"><div class="line">&lt;<span class="keywordtype">mujoco</span>&gt;</div>
<div class="line">&lt;<span class="keywordtype">compiler</span></div>
<div class="line">        <span class="keyword">meshdir</span>=<span class="stringliteral">&quot;meshes/&quot;</span></div>
<div class="line">        <span class="keyword">balanceinertia</span>=<span class="stringliteral">&quot;true&quot;</span></div>
<div class="line">        <span class="keyword">discardvisual</span>=<span class="stringliteral">&quot;false&quot;</span> /&gt;</div>
<div class="line">&lt;/<span class="keywordtype">mujoco</span>&gt;</div>
</div><!-- fragment --><p>change the working directory to <code>mujoco-3.x.x/bin</code>, run the command: </p><div class="fragment"><div class="line">./simulate</div>
</div><!-- fragment --><p>drag the urdf file into the simulation interface, after the model displaying correctly save the xml file. You should note the path of the mesh files.</p>
<p>You can also reference the Mujoco <a href="https://mujoco.readthedocs.io/en/stable/XMLreference.html">documentation</a> to set tags like <code>compiler</code>, <code>option</code> or <code>asset</code> to customize <code>body</code>, <code>actuator</code> and <code>sensor</code> etc.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">parent label   </th><th class="markdownTableHeadNone">child label    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><em>worldbody</em>   </td><td class="markdownTableBodyNone">define light, camera, floor and robot(inertial, joint, freejoint, geom, site, camera, light etc)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><em>actuator</em>   </td><td class="markdownTableBodyNone">define actuators (motor, position, velocity etc)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><em>sensor</em>   </td><td class="markdownTableBodyNone">define the sensors and adjust the sensors parameters like noises   </td></tr>
</table>
<p><b>2. replace the model</b></p>
<p>Take the "AzureDragon robot" as an example: under <em>base_link</em>, there are four tandem connections in parallel: the head <em>Link_head_</em>, the waist <em>Link_waist_</em>, the left arm <em>Link</em>_arm_l_, and the right arm <em>Link_arm_r_</em> branches. The left arm and right arm branches each have 7 degrees of freedom and the head branch has 2 degrees of freedom. The waist branch has 3 degrees of freedom including pitch*Link_waist_pitch*, roll*Link_waist_roll*, yaw*Link_waist_yaw*, etc., and the left leg and right leg branches are connected in parallel, and each leg is connected with three hip joints*Link_*hip* and one knee joint*Link_knee_* in turn, two ankle joints <em>Link_ankel_</em> and in total 6 degrees of freedom. This completes the configuration of all the 31 degrees of freedom.</p>
<p>You can reference this configuration and try to customize your configuration.</p>
<div class="fragment"><div class="line">&lt;<span class="keywordtype">worldbody</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">body</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;base_link&quot;</span> <span class="keyword">pos</span>=<span class="stringliteral">&quot;x x x&quot;</span>&gt;</div>
<div class="line">        &lt;<span class="keywordtype">freejoint</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;float_base&quot;</span> /&gt;</div>
<div class="line">        &lt;<span class="keywordtype">body</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;body1&quot;</span> <span class="keyword">pos</span>=<span class="stringliteral">&quot;x x x&quot;</span>&gt;</div>
<div class="line">            &lt;<span class="keywordtype">inertial</span> <span class="keyword">pos</span>=<span class="stringliteral">&quot;x x x&quot;</span> <span class="keyword">quat</span>=<span class="stringliteral">&quot;x x x&quot;</span> <span class="keyword">mass</span>=<span class="stringliteral">&quot;x&quot;</span> <span class="keyword">diaginertia</span>=<span class="stringliteral">&quot;x x x&quot;</span>/&gt;</div>
<div class="line">            &lt;<span class="keywordtype">joint</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;joint1&quot;</span> <span class="keyword">pos</span>=<span class="stringliteral">&quot;0 0 0&quot;</span> <span class="keyword">axis</span>=<span class="stringliteral">&quot;1 0 0&quot;</span> <span class="keyword">limited</span>=<span class="stringliteral">&quot;true&quot;</span> <span class="keyword">range</span>=<span class="stringliteral">&quot;x x&quot;</span>/&gt;</div>
<div class="line">            &lt;<span class="keywordtype">geom</span> <span class="keyword">type</span>=<span class="stringliteral">&quot;mesh&quot;</span> <span class="keyword">contype</span>=<span class="stringliteral">&quot;0&quot;</span> <span class="keyword">conaffinity</span>=<span class="stringliteral">&quot;0&quot;</span> <span class="keyword">group</span>=<span class="stringliteral">&quot;1&quot;</span> <span class="keyword">density</span>=<span class="stringliteral">&quot;0&quot;</span> <span class="keyword">rgba</span>=<span class="stringliteral">&quot;x x x 1&quot;</span> <span class="keyword">mesh</span>=<span class="stringliteral">&quot;body1&quot;</span>/&gt;</div>
<div class="line">            &lt;<span class="keywordtype">geom</span> <span class="keyword">type</span>=<span class="stringliteral">&quot;mesh&quot;</span> <span class="keyword">rgba</span>=<span class="stringliteral">&quot;x x x 1&quot;</span> <span class="keyword">mesh</span>=<span class="stringliteral">&quot;body1&quot;</span>/&gt;</div>
<div class="line">            &lt;<span class="keywordtype">body</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;body2&quot;</span> <span class="keyword">pos</span>=<span class="stringliteral">&quot;x x x&quot;</span>&gt;</div>
<div class="line">                ...</div>
<div class="line">                &lt;<span class="keywordtype">joint</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;joint2&quot;</span> .../&gt;</div>
<div class="line">                ...</div>
<div class="line">            &lt;/<span class="keywordtype">body</span>&gt;</div>
<div class="line">        &lt;/<span class="keywordtype">body</span>&gt;</div>
<div class="line">        &lt;<span class="keywordtype">body</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;body3&quot;</span> <span class="keyword">pos</span>=<span class="stringliteral">&quot;x x x&quot;</span>&gt;</div>
<div class="line">            ...</div>
<div class="line">            &lt;<span class="keywordtype">joint</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;joint3&quot;</span> .../&gt;</div>
<div class="line">            ...</div>
<div class="line">        &lt;/<span class="keywordtype">body</span>&gt;</div>
<div class="line">    &lt;/<span class="keywordtype">body</span>&gt;</div>
<div class="line">&lt;/<span class="keywordtype">worldbody</span>&gt;</div>
</div><!-- fragment --><p>In this case, two branches are connected in parallel under <em>base_link</em>, one branch consists of <em>body1</em> and <em>body2</em> in series, and the other branch consists of <em>body3</em>. If the robot has a floating base, add the free joint <em>freejoint</em> under <em>body</em> named <em>base_link</em> above. If the robot is a fixed base, remove the <em>freejoint</em> . Optionally, <em>freejoint</em> can be masked out during the model configuration phase, if desired.</p>
<p>This project sets actuator for each of the 31 joints.</p>
<div class="fragment"><div class="line">&lt;<span class="keywordtype">actuator</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">motor</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;motor1&quot;</span>  <span class="keyword">joint</span>=<span class="stringliteral">&quot;joint1&quot;</span> <span class="keyword">gear</span>=<span class="stringliteral">&quot;x&quot;</span> <span class="keyword">ctrllimited</span>=<span class="stringliteral">&quot;true&quot;</span> <span class="keyword">ctrlrange</span>=<span class="stringliteral">&quot;x x&quot;</span>/&gt;</div>
<div class="line">    ...</div>
<div class="line">&lt;/<span class="keywordtype">actuator</span>&gt;</div>
</div><!-- fragment --><p>The user can define the corresponding actuators at the active joints depending on the degrees of freedom of the robot.</p>
<p>The project is configured with sensors such as quaternion <em>framequat</em>, velocimeter <em>velocimeter</em>, angular velocimeter <em>gyro</em>, accelerometer <em>accelerometer</em>, which are mounted at the <em>site</em> already defined in the <em>body</em> tag, and can be added according to the needs of <em>touch</em>, <em>force</em>, <em>torque</em>, <em>jointpos</em>, <em>jointvel</em>, <em>actuatorfrc</em>, <em>actuatorfrc</em>. force*, <em>torque</em>, <em>jointpos</em>, <em>jointvel</em>, <em>actuatorfrc</em> and other sensors can be added as required.</p>
<div class="fragment"><div class="line">&lt;<span class="keywordtype">sensor</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">framequat</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;xx&quot;</span> <span class="keyword">objtype</span>=<span class="stringliteral">&quot;site&quot;</span> <span class="keyword">objname</span>=<span class="stringliteral">&quot;imu&quot;</span> /&gt;</div>
<div class="line">    &lt;<span class="keywordtype">velocimeter</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;xx&quot;</span> <span class="keyword">site</span>=<span class="stringliteral">&quot;imu&quot;</span> /&gt;</div>
<div class="line">    &lt;<span class="keywordtype">gyro</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;xx&quot;</span> <span class="keyword">site</span>=<span class="stringliteral">&quot;imu&quot;</span> /&gt;</div>
<div class="line">    &lt;<span class="keywordtype">accelerometer</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;xx&quot;</span> <span class="keyword">site</span>=<span class="stringliteral">&quot;imu&quot;</span> /&gt;</div>
<div class="line">&lt;/<span class="keywordtype">sensor</span>&gt;</div>
</div><!-- fragment --><p> In addition to the degree of freedom configuration, actuator configuration, sensor configuration, other more specific parameter modifications can refer to the Mojoco official <a href="https://mujoco.readthedocs.io/en/stable/XMLreference.html">documentation</a>.</p>
<h3><a class="anchor" id="autotoc_md21"></a>
Control code and Mujoco interface</h3>
<p>Use fuction <code>mj_loadXML</code>, <code>mj_makeData</code>to get <code>mjModel</code>, <code>mjData</code> struct. You can reference the <a href="https://mujoco.readthedocs.io/en/stable/XMLreference.html">documentation</a> for more details of <code>mjModel</code>, <code>mjData</code>, <code>mjOption</code>. </p><div class="fragment"><div class="line"> {C++}</div>
<div class="line">mjModel* mj_model = mj_loadXML(&quot;../Models/xxx.xml&quot;, 0, error, 1000);</div>
<div class="line">mjData* mj_data = mj_makeData(mj_model);</div>
</div><!-- fragment --><p><code>mj_model-&gt;nv</code> is the dimension of generalized velocity coordinate, i.e. the linear velocity, angular velocity of the floating base, and the velocity of the 31 joints of the rotational type. The variables related to the degrees of freedom in the program framework of the project are corresponding to <code>mj_model-&gt;nv-6</code>, and the dynamics library will automatically get the dimensions of the degrees of freedom of the robot according to the URDF, where all the dimension information are defined. Thus users don't have to modify it in the program manually.</p>
<p>As the access to the addresses of <em>body</em>, <em>joint</em>, <em>motor</em> and other components of this project relies on querying the name string and locking the address, when a component is modified, it will not affect the data reading and writing of other <em>body</em>, <em>joint</em>, and provide convenience for modifying the model compared to the direct indexing number. When modifying the control parameters of a certain degree of freedom in the model, you only need to modify the <code>JointName</code> of <em>MJ_Interface.h</em>, the <code>motorName</code> of <em>Pin_KinDyn.h</em>, the <code>motorName</code> of <em>PVT_Ctr.h</em>, and the variables corresponding to the name of a certain degree of freedom in the <em>JointCtrConfig.json</em> file. For example, to modify the stiffness of <code>J_waist_pitch</code>, you need to modify <code>J_waist_pitch</code> and the corresponding PD parameter in <em>JointCtrConfig.json</em>, and the name of <code>J_waist_pitch</code> corresponds to the <em>joint name</em>, <em>motor name</em> in the xml file.</p>
<p>The sensor data address is also accessed by querying the name string to find the address, adding or deleting sensors can be done by modifying the corresponding sensor name in <em>MJ_Interface.h</em>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
